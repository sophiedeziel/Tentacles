#!/usr/bin/env ruby
# frozen_string_literal: true

require 'simplecov'

# Find all coverage result files
coverage_files = Dir['coverage/.resultset*.json'] + Dir['coverage/*.json']
coverage_files = coverage_files.select { |f| File.basename(f).include?('resultset') || File.basename(f) == '.resultset.json' }

puts "Found coverage files: #{coverage_files}"

if coverage_files.empty?
  puts "ERROR: No coverage result files found in coverage directory"
  puts "Contents of coverage directory:"
  system('ls -la coverage/')
  exit 1
end

# Merge all coverage results from parallel runs
SimpleCov.collate coverage_files do
  coverage_dir 'coverage/merged'
  
  # Apply the same filters as the main configuration
  add_filter '/spec/'
  add_filter '/config/'
  add_filter '/vendor/'
  
  # Set minimum coverage for merged results
  minimum_coverage 70
  
  # Generate merged report
  formatter SimpleCov::Formatter::MultiFormatter.new([
    SimpleCov::Formatter::HTMLFormatter,
    SimpleCov::Formatter::SimpleFormatter
  ])
end

puts "Coverage reports merged successfully!"
puts "Merged coverage report available in coverage/merged/"